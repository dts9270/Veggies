<!doctype html>
<html lang="mr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DS Vegetable - Parbhani (Web App)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body{font-family: 'Poppins', sans-serif; background:#f7fbf7}
    .brand{font-weight:700}
    .card-img{height:90px; object-fit:cover}
    .marathi{font-family: 'Noto Sans Devanagari', sans-serif}
    .small-note{font-size:0.9rem; color:#555}
  </style>
</head>

<body class="marathi">

<!---------------- NAVBAR ---------------->
<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm mb-4">
  <div class="container">
    <a class="navbar-brand d-flex align-items-center" href="#">
      <img src="https://img.icons8.com/fluency/48/vegetarian-food.png" style="height:40px;margin-right:8px">
      <div>
        <div class="brand">DS Vegetable</div>
        <div style="font-size:0.8rem">Parbhani — Donhi</div>
      </div>
    </a>

    <div>
      <button class="btn btn-outline-success me-2" id="adminBtn">Admin</button>
      <button class="btn btn-success" id="cartBtn">
        कार्ट (<span id="cartCount">0</span>)
      </button>
    </div>
  </div>
</nav>

<div class="container">

  <!---------------- HEADER ---------------->
  <div class="row mb-3">
    <div class="col-md-8">
      <h4>आजची उपलब्धता — DS Vegetable</h4>
      <p class="small-note">तुम्ही खाली आयटमचे प्रमाण द्या (उदा. 1 kg / 250 g)</p>
    </div>

    <div class="col-md-4 text-end">
      <div class="card p-2">
        <div><strong>डिलिव्हरी एरिया:</strong> Parbhani City (Donhi)</div>
        <div><strong>फ्री डिलिव्हरी:</strong> ₹500 वर</div>
        <div><strong>डिलिव्हरी चार्ज:</strong> ₹20</div>
      </div>
    </div>
  </div>

  <!---------------- PRODUCT GRID ---------------->
  <div id="productGrid" class="row g-3"></div>

  <hr class="my-4">

  <!---------------- GOOGLE SHEET INFO ---------------->
  <div class="d-flex justify-content-between align-items-center">
    <div>
      <label class="form-label"><strong>Google Sheet वापरून स्टॉक अपडेट करा</strong></label>
      <p class="small-note">
        Admin → Load From Google Sheet दाबा.  
        Sheet public असणे आवश्यक आहे.
      </p>
    </div>
  </div>

</div>

<!---------------------------------------------------
                     CART MODAL
--------------------------------------------------->
<div class="modal fade" id="cartModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">तुझा कार्ट</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <div id="cartItems"></div>
        <hr>

        <div class="d-flex justify-content-between">
          <div>
            <label>नाव:</label>
            <input id="custName" class="form-control">

            <label class="mt-2">पत्ता:</label>
            <input id="custAddress" class="form-control">

            <label class="mt-2">फोन:</label>
            <input id="custPhone" class="form-control">
          </div>

          <div style="min-width:260px">
            <h6>Order Summary</h6>

            <div>Subtotal: ₹<span id="subtotal">0</span></div>
            <div>डिलिव्हरी चार्ज: ₹<span id="deliveryCharge">0</span></div>
            <div class="fw-bold mt-2">Total: ₹<span id="totalAmount">0</span></div>

            <button id="whatsappOrder" class="btn btn-success w-100 mt-3">WhatsApp वर पाठवा</button>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!---------------------------------------------------
                     ADMIN MODAL
--------------------------------------------------->
<div class="modal fade" id="adminModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Admin — DS Vegetable</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <h6 class="mb-2">Google Sheet</h6>

        <input id="sheetUrl" class="form-control mb-2"
               value="https://docs.google.com/spreadsheets/d/1CbbHxN3b_1BXCwhzh3kqI1v-wMSaQYCYPvFj2pWcO0I/edit?usp=drivesdk">

        <input id="sheetName" class="form-control mb-3" value="Sheet1">

        <button id="loadSheet" class="btn btn-success">Load From Google Sheet</button>

        <hr>

        <h6>Existing Items</h6>
        <div id="adminList"></div>
      </div>

    </div>
  </div>
</div>

<!---------------------------------------------------
                 JAVASCRIPT SECTION
--------------------------------------------------->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
function $(id){return document.getElementById(id)}

function extractSheetId(url){
  try { return url.match(/\/d\/(.*?)\//)[1]; }
  catch(e){ return null; }
}

async function fetchGoogleSheet(sheetId, sheetName){
  const url = `https://opensheet.elk.sh/${sheetId}/${sheetName}`;
  const res = await fetch(url);
  const data = await res.json();

  const products = data.map((r,idx)=>({
    id: Date.now()+idx,
    name: r.name,
    category: r.category || "भाजी",
    price: parseFloat(r.price)||0,
    unit: r.unit || "per kg",
    qty: r.qty || "",
    image: r.image || ""
  }));

  localStorage.setItem("products", JSON.stringify(products));
  renderProducts();
  renderAdmin();
  alert("Google Sheet मधून डेटा यशस्वीपणे लोड झाला!");
}

function loadProducts(){
  return JSON.parse(localStorage.getItem("products")||"[]");
}

function renderProducts(){
  const products = loadProducts();
  const grid = $("productGrid");
  grid.innerHTML = "";

  products.forEach(p=>{
    const div = document.createElement("div");
    div.className="col-md-3";

    div.innerHTML = `
      <div class="card shadow-sm h-100">
        <img src="${p.image||'https://img.icons8.com/fluency/96/vegetarian-food.png'}" class="card-img">
        <div class="card-body">
          <h6>${p.name}</h6>
          <div class="small-note">${p.category} • ${p.unit}</div>
          <div class="mt-2 fw-bold">₹${p.price}</div>

          <input type="text" placeholder="प्रमाण" class="form-control mt-2 qtyInput" data-id="${p.id}">

          <button class="btn btn-success w-100 mt-2 addBtn" data-id="${p.id}">
            Add
          </button>
        </div>
      </div>
    `;

    grid.appendChild(div);
  });

  attachEvents();
}

function attachEvents(){
  document.querySelectorAll(".addBtn").forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.dataset.id;
      const qty = document.querySelector(`.qtyInput[data-id="${id}"]`).value;

      if(!qty) return alert("प्रमाण टाका");

      let cart = JSON.parse(localStorage.getItem("cart")||"[]");
      const products = loadProducts();
      const p = products.find(x=>x.id==id);

      cart.push({name:p.name, qty, price:p.price});
      localStorage.setItem("cart", JSON.stringify(cart));

      updateCart();
      alert("कार्टमध्ये अँड झाले!");
    };
  });
}

function updateCart(){
  let cart = JSON.parse(localStorage.getItem("cart")||"[]");
  $("cartCount").innerText = cart.length;
}

function openCart(){
  const modal = new bootstrap.Modal($("#cartModal"));
  renderCart();
  modal.show();
}

function renderCart(){
  let cart = JSON.parse(localStorage.getItem("cart")||"[]");
  let html = "";
  let subtotal = 0;

  cart.forEach((c,i)=>{
    subtotal += c.price;

    html += `
      <div class="d-flex justify-content-between mt-2">
        <div>${c.name} — ${c.qty}</div>
        <div>₹${c.price}</div>
      </div>
    `;
  });

  $("cartItems").innerHTML = html;
  $("subtotal").innerText = subtotal;
  $("deliveryCharge").innerText = subtotal >= 500 ? 0 : 20;
  $("totalAmount").innerText = subtotal + (subtotal>=500?0:20);
}

$("#cartBtn").onclick = openCart;
updateCart();

$("#adminBtn").onclick = ()=>{
  const modal = new bootstrap.Modal($("#adminModal"));
  modal.show();
  renderAdmin();
};

function renderAdmin(){
  const products = loadProducts();
  const list = $("adminList");
  list.innerHTML = "";

  products.forEach(p=>{
    list.innerHTML += `
      <div class="border p-2 mb-2 d-flex justify-content-between">
        <div>${p.name} — ₹${p.price}</div>
      </div>
    `;
  });
}

$("#loadSheet").onclick = ()=>{
  const url = $("sheetUrl").value;
  const name = $("sheetName").value;

  const id = extractSheetId(url);
  if(!id) return alert("Sheet ID सापडला नाही!");

  fetchGoogleSheet(id, name);
};

$("#whatsappOrder").onclick = ()=>{
  let cart = JSON.parse(localStorage.getItem("cart")||"[]");
  let msg = "*DS Vegetable Order*%0A%0A";

  cart.forEach(c=>{
    msg += `${c.name} - ${c.qty} - ₹${c.price}%0A`;
  });

  msg += "%0ATotal: ₹" + $("totalAmount").innerText;

  window.open(`https://wa.me/91XXXXXXXXXX?text=${msg}`);
};
</script>

</body>
      </html>
